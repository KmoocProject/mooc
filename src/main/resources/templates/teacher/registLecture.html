<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="teacher/common/header :: head"></head>
<style>
    .progress-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding: 0 1rem;
    }
    .step {
        position: relative;
        flex: 1;
        text-align: center;
        padding: 1rem;
        font-weight: bold;
    }
    .step::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: #e9ecef;
        z-index: 1;
    }
    .step.active::after {
        background: #0d6efd;
    }
    .step.completed::after {
        background: #198754;
    }
    .step-content {
        display: none;
    }
    .step-content.active {
        display: block;
    }
    .content-preview {
        max-width: 200px;
        max-height: 200px;
        object-fit: contain;
    }
</style>
<body>
    <nav th:replace="teacher/common/nav :: nav"></nav>
    <div class="container mt-5">
        <!-- 진행 단계 표시 -->
        <div class="progress-steps mb-4">
            <div class="step active" data-step="1">1. 기본 정보</div>
            <div class="step" data-step="2">2. 섹션 구성</div>
            <div class="step" data-step="3">3. 콘텐츠 등록</div>
        </div>

        <!-- 스텝 1: 기본 정보 -->
        <div class="step-content active" id="step1">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>강좌 기본 정보</h4>
                </div>
                <div class="card-body">
                    <form id="courseForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">강좌 제목</label>
                                <input type="text" class="form-control" name="title" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">과목 선택</label>
                                <select class="form-select" name="subjectId" required>
                                    <option value="">과목을 선택하세요</option>
                                    <th:block th:each="subject : ${subjects}">
                                        <option th:value="${subject.subjectId}" 
                                                th:text="${subject.subjectName}">
                                        </option>
                                    </th:block>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">주차 수</label>
                                <input type="number" class="form-control" name="weeks" required min="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">학습 시간(분)</label>
                                <input type="number" class="form-control" name="learningTime" required min="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">언어</label>
                                <select class="form-select" name="language" required>
                                    <option value="ko">한국어</option>
                                    <option value="en">영어</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">강좌 설명</label>
                            <textarea class="form-control" name="description" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">썸네일 이미지</label>
                            <input type="file" class="form-control" name="thumbnail" accept="image/*" required>
                            <div id="thumbnailPreview" class="mt-2"></div>
                        </div>
                        <div class="form-check mb-3">
                            <div class="form-group">
                                <label>학점은행제 강좌 여부</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" 
                                           name="isCreditBank" id="isCreditBank0" value="0" checked>
                                    <label class="form-check-label" for="isCreditBank0">
                                        일반 강좌
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" 
                                           name="isCreditBank" id="isCreditBank1" value="1">
                                    <label class="form-check-label" for="isCreditBank1">
                                        학점은행제 강좌
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-primary" onclick="nextStep(1)">다음</button>
            </div>
        </div>

        <!-- 스텝 2: 섹션 구성 -->
        <div class="step-content" id="step2">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>섹션 구성</h4>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addSection()">섹션 추가</button>
                </div>
                <div class="card-body">
                    <div id="sectionContainer">
                        <!-- 섹션 템플릿 -->
                        <div class="section-item mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="section-title">섹션 1</h5>
                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeSection(this)">삭제</button>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">섹션 제목</label>
                                        <input type="text" class="form-control" name="sectionTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">섹션 설명</label>
                                        <textarea class="form-control" name="sectionDescription" rows="2" required></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" onclick="prevStep(2)">이전</button>
                <button type="button" class="btn btn-primary" onclick="nextStep(2)">다음</button>
            </div>
        </div>

        <!-- 스텝 3: 콘텐츠 등록 -->
        <div class="step-content" id="step3">
            <div id="contentContainer">
                <!-- 섹션별 콘텐츠 등록 영역이 동적으로 생성됨 -->
            </div>
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" onclick="prevStep(3)">이전</button>
                <button type="button" class="btn btn-success" onclick="submitCourse()">강좌 등록 완료</button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        let currentStep = 1;
        let courseData = null;
        let isSubmitting = false;  // 중복 제출 방지 플래그
        let sectionLectureIds = [];  // 전역 변수 추가

        // 파일 미리보기
        document.querySelector('input[name="thumbnail"]').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('thumbnailPreview').innerHTML = 
                        `<img src="${e.target.result}" class="content-preview">`;
                }
                reader.readAsDataURL(file);
            }
        });

        function nextStep(step) {
            if (validateStep(step)) {
                if (step === 1) {
                    saveBasicInfo().then(success => {
                        if (success) {
                            showStep(step + 1);
                        }
                    });
                } else if (step === 2) {
                    saveSections().then(success => {
                        if (success) {
                            showStep(step + 1);
                        }
                    });
                }
            }
        }

        function prevStep(step) {
            showStep(step - 1);
        }

        function showStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.step').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.step < step) {
                    el.classList.add('completed');
                }
            });
            
            document.getElementById(`step${step}`).classList.add('active');
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
            currentStep = step;

            if (step === 3) {
                generateContentForms();
            }
        }

        function validateStep(step) {
            if (step === 1) {
                const form = document.getElementById('courseForm');
                return form.checkValidity();
            } else if (step === 2) {
                const sections = document.querySelectorAll('.section-item');
                return sections.length > 0 && Array.from(sections).every(section => {
                    return section.querySelector('[name="sectionTitle"]').value.trim() !== '' &&
                           section.querySelector('[name="sectionDescription"]').value.trim() !== '';
                });
            }
            return true;
        }

        async function saveBasicInfo() {
            // 이미 제출 중이면 리턴
            if (isSubmitting) {
                return false;
            }
            
            const form = document.getElementById('courseForm');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return false;
            }

            try {
                isSubmitting = true;  // 제출 시작
                const formData = new FormData(form);
                
                console.log('강좌 등록 시작');
                const response = await fetch('/api/teacher/courses', {
                    method: 'POST',
                    body: formData
                });

                const responseText = await response.text();
                console.log('서버 응답:', responseText);

                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(responseText || '강좌 등록에 실패했습니다.');
                }

                if (!response.ok) {
                    throw new Error(responseData.message || '강좌 등록에 실패했습니다.');
                }

                courseData = responseData;
                console.log('강좌 데이터 저장됨:', courseData);
                
                if (courseData && courseData.courseId) {
                    console.log('다음 단계로 이동');
                    nextStep(1);
                    return true;
                }
                
                throw new Error('강좌 데이터가 올바르지 않습니다.');
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
                return false;
            } finally {
                isSubmitting = false;  // 제출 완료
            }
        }

        async function saveSections() {
            if (!courseData?.courseId) {
                alert('강좌 기본 정보가 없습니다.');
                return false;
            }

            const sections = Array.from(document.querySelectorAll('.section-item')).map((section, index) => ({
                courseId: courseData.courseId,
                title: section.querySelector('[name="sectionTitle"]').value,
                description: section.querySelector('[name="sectionDescription"]').value
            }));

            try {
                const response = await fetch(`/api/teacher/courses/${courseData.courseId}/sections`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sections)
                });

                if (response.ok) {
                    const lectureData = await response.json();
                    sectionLectureIds = lectureData.map(lecture => lecture.lectureId);  // lectureId 배열 저장
                    console.log('섹션 lectureIds:', sectionLectureIds);
                    return true;
                }
                throw new Error('섹션 저장에 실패했습니다.');
            } catch (error) {
                console.error('섹션 저장 에러:', error);
                alert('섹션 저장에 실패했습니다.');
                return false;
            }
        }

        function addSection() {
            const container = document.getElementById('sectionContainer');
            const sectionCount = container.children.length + 1;
            
            const template = container.children[0].cloneNode(true);
            template.querySelector('.section-title').textContent = `섹션 ${sectionCount}`;
            template.querySelectorAll('input, textarea').forEach(input => input.value = '');
            
            container.appendChild(template);
        }

        function removeSection(button) {
            const sections = document.getElementsByClassName('section-item');
            if (sections.length > 1) {
                button.closest('.section-item').remove();
                // 섹션 번호 재정렬
                Array.from(sections).forEach((section, index) => {
                    section.querySelector('.section-title').textContent = `섹션 ${index + 1}`;
                });
            } else {
                alert('최소 1개의 섹션이 필요합니다.');
            }
        }

        function generateContentForms() {
            const container = document.getElementById('contentContainer');
            container.innerHTML = '';

            document.querySelectorAll('.section-item').forEach((section, index) => {
                const sectionTitle = section.querySelector('[name="sectionTitle"]').value;
                container.insertAdjacentHTML('beforeend', `
                    <div class="card mb-4" data-section-index="${index}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>${sectionTitle}</h5>
                            <button type="button" class="btn btn-primary btn-sm" onclick="addContent(${index})">
                                콘텐츠 추가
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="content-list">
                                <!-- 기본 콘텐츠 템플릿 -->
                                ${getContentTemplate(index, 0)}
                            </div>
                        </div>
                    </div>
                `);
            });
        }

        function getContentTemplate(sectionIndex, contentIndex) {
            return `
                <div class="content-item mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">콘텐츠 제목</label>
                                <input type="text" class="form-control" name="contentTitle" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">콘텐츠 설명</label>
                                <textarea class="form-control" name="contentDescription" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">콘텐츠 유형</label>
                                <select class="form-select content-type" onchange="updateUploadArea(this)">
                                    <option value="">선택하세요</option>
                                    <option value="video">동영상</option>
                                    <option value="file">문서</option>
                                    <option value="quiz">퀴즈</option>
                                </select>
                            </div>
                            <div class="content-upload-area"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateUploadArea(select) {
            const contentItem = select.closest('.content-item');
            const uploadArea = contentItem.querySelector('.content-upload-area');
            const descriptionField = contentItem.querySelector('[name="contentDescription"]').closest('.mb-3');
            const type = select.value;
            let html = '';

            // 설명 필드 표시/숨김 처리
            if (type === 'quiz') {
                descriptionField.style.display = 'none';
            } else {
                descriptionField.style.display = 'block';
            }

            if (type === 'video' || type === 'file') {
                const fileType = type === 'video' ? 'video/*' : '*/*';
                html = `
                    <div class="mb-3">
                        <label class="form-label">${type === 'video' ? '동영상' : '문서'} 파일</label>
                        <input type="file" class="form-control" accept="${fileType}" required>
                        <div class="preview mt-2"></div>
                    </div>
                `;
            } else if (type === 'quiz') {
                html = `
                    <div class="mb-3">
                        <label class="form-label">퀴즈 문제</label>
                        <textarea class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">정답</label>
                        <input type="text" class="form-control" required>
                    </div>
                `;
            }

            uploadArea.innerHTML = html;

            if (type === 'video' || type === 'file') {
                const fileInput = uploadArea.querySelector('input[type="file"]');
                const preview = uploadArea.querySelector('.preview');
                
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    if (type === 'video') {
                        preview.innerHTML = `
                            <video class="content-preview mt-2" controls>
                                <source src="${URL.createObjectURL(file)}" type="video/mp4">
                            </video>
                        `;
                    } else {
                        preview.innerHTML = `
                            <div class="mt-2">
                                <i class="bi bi-file-earmark"></i> ${file.name}
                            </div>
                        `;
                    }
                });
            }
        }

        function addContent(sectionIndex) {
            const contentList = document.querySelector(`[data-section-index="${sectionIndex}"] .content-list`);
            const contentCount = contentList.children.length;
            contentList.insertAdjacentHTML('beforeend', getContentTemplate(sectionIndex, contentCount));
        }

        function removeContent(button) {
            const contentList = button.closest('.content-list');
            if (contentList.children.length > 1) {
                button.closest('.content-item').remove();
            } else {
                alert('최소 1개의 콘텐츠가 필요합니다.');
            }
        }

        async function submitCourse() {
            if (!validateContents()) {
                alert('모든 콘텐츠 정보를 입력해주세요.');
                return;
            }

            try {
                const sections = document.querySelectorAll('.card[data-section-index]');
                
                for (let i = 0; i < sections.length; i++) {
                    const section = sections[i];
                    const lectureId = sectionLectureIds[i];
                    
                    const contents = section.querySelectorAll('.content-item');
                    
                    for (let j = 0; j < contents.length; j++) {
                        const contentItem = contents[j];
                        const formData = new FormData();
                        
                        // 필수 필드 추가
                        formData.append('title', contentItem.querySelector('[name="contentTitle"]').value);
                        const type = contentItem.querySelector('.content-type').value;

                        // 퀴즈가 아닐 때만 description 추가
                        if (type !== 'quiz') {
                            formData.append('description', contentItem.querySelector('[name="contentDescription"]').value);
                        }

                        formData.append('type', contentItem.querySelector('.content-type').value);
                        
                        const uploadArea = contentItem.querySelector('.content-upload-area');

                        if (type === 'video') {
                            formData.append('isVideo', '1');
                            const file = uploadArea.querySelector('input[type="file"]').files[0];
                            if (file) {
                                formData.append('file', file);
                            }
                        } else if (type === 'file') {
                            formData.append('isVideo', '0');
                            const file = uploadArea.querySelector('input[type="file"]').files[0];
                            if (file) {
                                formData.append('file', file);
                            }
                        } else if (type === 'quiz') {
                            formData.append('isVideo', '0');
                            formData.append('question', uploadArea.querySelector('textarea').value);
                            formData.append('answer', uploadArea.querySelector('input[type="text"]').value);
                        }

                        const response = await fetch(`/api/teacher/lectures/${lectureId}/contents`, {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            throw new Error(`섹션 ${i + 1}의 콘텐츠 ${j + 1} 등록 실패`);
                        }
                    }
                }

                alert('강좌가 성공적으로 등록되었습니다.');
                window.location.href = '/teacher/myLectures';
            } catch (error) {
                console.error('Error submitting course:', error);
                alert('강좌 등록에 실패했습니다: ' + error.message);
            }
        }

        function validateContents() {
            let valid = true;
            document.querySelectorAll('.content-item').forEach(item => {
                const title = item.querySelector('[name="contentTitle"]').value;
                const type = item.querySelector('.content-type').value;
                const uploadArea = item.querySelector('.content-upload-area');

                if (!title || !type) {
                    valid = false;
                    return;
                }

                if (type === 'video' || type === 'file') {
                    const file = uploadArea.querySelector('input[type="file"]').files[0];
                    if (!file) valid = false;
                } else if (type === 'quiz') {
                    const question = uploadArea.querySelector('textarea').value;
                    const answer = uploadArea.querySelector('input[type="text"]').value;
                    if (!question || !answer) valid = false;
                }
            });
            return valid;
        }

        // 이벤트 리스너 등록 부분도 확인
        document.addEventListener('DOMContentLoaded', function() {
            // 기존 이벤트 리스너 제거
            const form = document.getElementById('courseForm');
            const oldForm = form.cloneNode(true);
            form.parentNode.replaceChild(oldForm, form);
        });
    </script>
</body>
</html>